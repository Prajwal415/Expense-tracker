<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>Add Expense ‚Äî Expense Tracker</title>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<style>
  :root {
    --accent: #3f67e6;
    --accent-dark: #2949c0;
    --accent-light: #eef2ff;
    --danger: #ff6b6b;
    --success: #0b6e4f;
    --muted: #6b7280;
    --bg: #f5f7fb;
    --card: #fff;
    --border: #e6e9ef;
    --radius: 12px;
    --transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }

  * {
    box-sizing: border-box;
    -webkit-tap-highlight-color: transparent;
  }

  html, body {
    width: 100%;
    height: 100%;
    margin: 0;
    padding: 0;
  }

  body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Helvetica Neue", sans-serif;
    background: var(--bg);
    color: #0b2340;
    -webkit-font-smoothing: antialiased;
    -webkit-touch-callout: none;
    user-select: none;
  }

  body, input, select, textarea, button {
    -webkit-user-select: none;
    user-select: none;
  }

  .wrap {
    max-width: 1200px;
    margin: 0 auto;
    padding: 16px clamp(12px, 4vw, 24px) 24px;
  }

  h1 {
    margin: 0 0 12px;
    font-size: clamp(22px, 6vw, 32px);
    font-weight: 700;
    letter-spacing: -0.5px;
    color: #0b2340;
  }

  a.link {
    color: var(--accent);
    text-decoration: none;
    font-size: clamp(12px, 2.5vw, 14px);
    font-weight: 500;
    display: inline-flex;
    align-items: center;
    gap: 4px;
    margin-bottom: 16px;
    transition: color var(--transition);
  }

  a.link:active {
    color: var(--accent-dark);
  }

  /* Form Elements */
  label {
    font-size: clamp(13px, 2.5vw, 15px);
    font-weight: 600;
    display: block;
    margin-top: 14px;
    color: #0b2340;
  }

  label:first-child {
    margin-top: 0;
  }

  input[type=number],
  input[type=text],
  input[list],
  select,
  textarea {
    width: 100%;
    padding: 12px clamp(12px, 2vw, 14px);
    border-radius: 10px;
    border: 1.5px solid var(--border);
    margin-top: 8px;
    font-size: 16px;
    font-family: inherit;
    background: white;
    color: #0b2340;
    transition: border-color var(--transition), box-shadow var(--transition);
    -webkit-appearance: none;
    appearance: none;
  }

  input[type=number]:focus,
  input[type=text]:focus,
  input[list]:focus,
  select:focus,
  textarea:focus {
    outline: none;
    border-color: var(--accent);
    box-shadow: 0 0 0 3px rgba(63, 103, 230, 0.1);
  }

  textarea {
    min-height: 70px;
    resize: vertical;
  }

  select {
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8' viewBox='0 0 12 8'%3E%3Cpath fill='%233f67e6' d='M1 1l5 5 5-5'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 12px center;
    padding-right: 36px;
  }

  /* Buttons */
  .btn {
    background: var(--accent);
    color: white;
    border: 0;
    padding: clamp(12px, 2vw, 14px) clamp(14px, 3vw, 18px);
    border-radius: 10px;
    cursor: pointer;
    font-weight: 700;
    font-size: clamp(13px, 2.5vw, 15px);
    min-height: 44px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all var(--transition);
    white-space: nowrap;
  }

  .btn:active {
    background: var(--accent-dark);
    transform: scale(0.96);
  }

  .btn:disabled {
    background: #ccc;
    cursor: not-allowed;
    opacity: 0.6;
  }

  .btn.secondary {
    background: var(--accent-light);
    color: var(--accent);
    font-weight: 600;
  }

  .btn.secondary:active {
    background: #dde5ff;
  }

  .btn.danger {
    background: #ffebe9;
    color: #c53030;
  }

  .btn.danger:active {
    background: #ffe0db;
  }

  .btn.success {
    background: var(--success);
    color: white;
  }

  .export-btn {
    background: var(--success);
    color: white;
    padding: clamp(10px, 1.5vw, 12px) clamp(12px, 2vw, 16px);
    border: 0;
    border-radius: 8px;
    cursor: pointer;
    font-size: clamp(12px, 2vw, 14px);
    min-height: 40px;
    font-weight: 600;
    white-space: nowrap;
    transition: all var(--transition);
  }

  .export-btn:active {
    background: #0a5540;
    transform: scale(0.96);
  }

  /* Grid & Layout */
  .grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: 16px;
    width: 100%;
  }

  @media (min-width: 1100px) {
    .grid {
      grid-template-columns: 1fr 380px;
    }
  }

  .row {
    display: flex;
    gap: 10px;
    align-items: center;
    flex-wrap: wrap;
  }

  .kpi-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
    gap: clamp(8px, 2vw, 12px);
    width: 100%;
  }

  /* Card */
  .card {
    background: var(--card);
    border-radius: var(--radius);
    padding: clamp(16px, 3vw, 20px);
    box-shadow: 0 4px 12px rgba(20, 30, 60, 0.08);
    margin-bottom: 16px;
    width: 100%;
    transition: box-shadow var(--transition);
  }

  .card:active {
    box-shadow: 0 8px 20px rgba(20, 30, 60, 0.12);
  }

  /* KPI Cards */
  .kpi {
    background: linear-gradient(135deg, #f9fbff 0%, #f5f9ff 100%);
    border-radius: 10px;
    padding: clamp(12px, 2vw, 16px);
    display: flex;
    flex-direction: column;
    justify-content: center;
    border: 1px solid var(--accent-light);
    transition: all var(--transition);
  }

  .kpi:active {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(63, 103, 230, 0.15);
  }

  .kpi div:first-child {
    font-weight: 700;
    font-size: clamp(16px, 3vw, 20px);
    margin: 4px 0;
    color: #0b2340;
  }

  .small {
    color: var(--muted);
    font-size: clamp(11px, 2vw, 13px);
    font-weight: 500;
  }

  .muted {
    color: var(--muted);
    font-size: clamp(11px, 2vw, 13px);
    margin-top: 4px;
  }

  h3 {
    font-size: clamp(16px, 3vw, 20px);
    margin: 0 0 clamp(8px, 2vw, 12px);
    color: #0b2340;
    font-weight: 700;
  }

  /* Table */
  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 12px;
    font-size: clamp(12px, 2vw, 14px);
  }

  th {
    background: linear-gradient(135deg, #f9fbff 0%, #f5f9ff 100%);
    padding: clamp(10px, 2vw, 14px);
    text-align: left;
    font-weight: 700;
    color: #0b2340;
    border-bottom: 2px solid var(--border);
  }

  td {
    padding: clamp(10px, 2vw, 14px);
    text-align: left;
    border-bottom: 1px solid var(--border);
    color: #0b2340;
  }

  tbody tr:hover {
    background: rgba(63, 103, 230, 0.03);
  }

  /* Suggestion Box */
  .suggest-box {
    padding: clamp(14px, 2vw, 18px);
    border-radius: 10px;
    background: linear-gradient(135deg, #f7fffa 0%, #f0fff6 100%);
    border-left: 4px solid #06b6d4;
    border: 1px solid #d0f4f0;
  }

  .suggest-box.danger-suggest {
    background: linear-gradient(135deg, #fff5f5 0%, #fff1f1 100%);
    border-left-color: #ff6b6b;
    border-color: #ffd6d6;
  }

  .suggest-title {
    display: flex;
    align-items: center;
    gap: 10px;
    font-weight: 700;
    font-size: clamp(14px, 2.5vw, 16px);
  }

  .suggest-title .dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    background: #06b6d4;
    flex-shrink: 0;
    animation: pulse 2s infinite;
  }

  .suggest-box.danger-suggest .suggest-title .dot {
    background: #ff6b6b;
  }

  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.6; }
  }

  .suggest-content {
    font-size: clamp(13px, 2.5vw, 16px);
    line-height: 1.5;
    color: #0b2340;
    margin-top: 10px;
  }

  .suggest-tips {
    margin-top: 10px;
    font-size: clamp(11px, 2vw, 13px);
    color: var(--muted);
    line-height: 1.4;
  }

  /* Delete Row */
  .delete-row {
    display: grid;
    grid-template-columns: 1fr auto;
    gap: clamp(8px, 2vw, 12px);
    margin-bottom: 16px;
  }

  @media (max-width: 480px) {
    .delete-row {
      grid-template-columns: 1fr;
    }
  }

  .delete-row select {
    min-height: 44px;
  }

  /* Quick Grid */
  .quick-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(75px, 1fr));
    gap: clamp(8px, 2vw, 12px);
    width: 100%;
    margin-top: clamp(12px, 2vw, 16px);
  }

  .quick-grid button {
    background: var(--accent-light);
    border: 1.5px solid var(--accent);
    color: var(--accent);
    padding: clamp(10px, 1.5vw, 12px);
    border-radius: 8px;
    cursor: pointer;
    font-size: clamp(12px, 2vw, 13px);
    font-weight: 600;
    min-height: 44px;
    transition: all var(--transition);
    white-space: normal;
    word-wrap: break-word;
  }

  .quick-grid button:active {
    background: var(--accent);
    color: white;
    transform: scale(0.95);
  }

  /* Card Header */
  .card-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    flex-wrap: wrap;
    gap: clamp(10px, 2vw, 16px);
  }

  @media (max-width: 480px) {
    .card-header {
      flex-direction: column;
      align-items: stretch;
    }

    .export-btn {
      width: 100%;
    }
  }

  /* Chart Container */
  .chart-card {
    display: flex;
    flex-direction: column;
    gap: clamp(14px, 2vw, 18px);
    width: 100%;
    margin-top: 16px;
  }

  .chart-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: clamp(10px, 2vw, 14px);
  }

  .chart-header h3 {
    margin: 0;
  }

  /* Chart Carousel - FIXED & IMPROVED */
  .chart-carousel {
    position: relative;
    width: 100%;
    overflow: hidden;
    touch-action: pan-y;
    -webkit-user-select: none;
    user-select: none;
  }

  .chart-slides {
    display: flex;
    transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    width: 100%;
    height: 100%;
  }

  .chart-slides.no-transition {
    transition: none;
  }

  .chart-slide {
    min-width: 100%;
    flex-shrink: 0;
    padding: 0;
    display: flex;
    justify-content: center;
    align-items: stretch;
  }

  /* Chart Holder */
  .chart-holder {
    width: 100%;
    height: auto;
    background: linear-gradient(135deg, #fafbff 0%, #f5f9ff 100%);
    padding: clamp(14px, 2vw, 18px);
    border-radius: 10px;
    box-shadow: 0 4px 12px rgba(10, 20, 40, 0.06);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    border: 1px solid var(--accent-light);
  }

  /* Mobile: 300px height */
  @media (max-width: 480px) {
    .chart-holder {
      min-height: 280px;
    }
  }

  /* Tablet: 350px height */
  @media (min-width: 481px) and (max-width: 768px) {
    .chart-holder {
      min-height: 320px;
    }
  }

  /* Laptop: 400px height */
  @media (min-width: 769px) and (max-width: 1099px) {
    .chart-holder {
      min-height: 380px;
    }
  }

  /* Desktop: both charts side by side */
  @media (min-width: 1100px) {
    .chart-carousel {
      height: auto;
    }

    .chart-slides {
      flex-wrap: wrap;
      gap: 12px;
      transform: none !important;
      width: auto;
    }

    .chart-slide {
      min-width: calc(50% - 6px);
      width: calc(50% - 6px);
    }

    .chart-holder {
      min-height: 420px;
    }
  }

  .chart-title {
    font-weight: 700;
    font-size: clamp(13px, 2.5vw, 16px);
    margin-bottom: clamp(10px, 2vw, 14px);
    text-align: center;
    flex-shrink: 0;
    color: #0b2340;
  }

  canvas {
    width: 100% !important;
    height: auto !important;
    max-height: 250px;
  }

  @media (min-width: 481px) {
    canvas {
      max-height: 300px;
    }
  }

  @media (min-width: 769px) {
    canvas {
      max-height: 350px;
    }
  }

  /* Navigation Buttons */
  .chart-nav {
    display: flex;
    gap: clamp(8px, 2vw, 12px);
    justify-content: center;
    align-items: center;
    flex-wrap: wrap;
    margin-top: clamp(12px, 2vw, 16px);
  }

  .chart-nav button {
    background: var(--accent);
    color: white;
    border: 0;
    padding: clamp(10px, 1.5vw, 12px) clamp(12px, 2vw, 16px);
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
    font-size: clamp(12px, 2vw, 14px);
    min-height: 40px;
    transition: all var(--transition);
  }

  .chart-nav button:active:not(:disabled) {
    background: var(--accent-dark);
    transform: scale(0.95);
  }

  .chart-nav button:disabled {
    background: #ccc;
    cursor: not-allowed;
    opacity: 0.5;
  }

  .chart-counter {
    font-size: clamp(12px, 2vw, 14px);
    color: var(--muted);
    font-weight: 600;
    min-width: 50px;
    text-align: center;
  }

  .swipe-indicator {
    text-align: center;
    font-size: clamp(11px, 2vw, 12px);
    color: var(--muted);
    margin-top: 8px;
    display: block;
    animation: slideIn 0.6s ease-out;
  }

  @keyframes slideIn {
    from {
      opacity: 0;
      transform: translateY(-4px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  @media (min-width: 1100px) {
    .swipe-indicator {
      display: none;
    }

    .chart-nav {
      display: none;
    }
  }

  .controls-col {
    display: flex;
    flex-direction: column;
    gap: clamp(12px, 2vw, 16px);
    width: 100%;
  }

  .controls-col > div {
    flex: 1;
  }

  /* Responsive */
  @media (max-width: 480px) {
    .wrap {
      padding: 12px 12px 20px;
    }

    .card {
      padding: clamp(14px, 2vw, 16px);
      border-radius: 12px;
    }

    .card-header {
      flex-direction: column;
    }

    h1 {
      margin-bottom: 8px;
    }

    .row {
      flex-direction: column;
    }

    .row button {
      width: 100%;
    }
  }

  @media (min-width: 481px) and (max-width: 768px) {
    .card {
      padding: 16px;
    }
  }

  /* Utility */
  .text-center {
    text-align: center;
  }

  /* Loading State */
  @keyframes shimmer {
    0% { opacity: 0.6; }
    50% { opacity: 1; }
    100% { opacity: 0.6; }
  }

  .loading {
    animation: shimmer 1.5s infinite;
  }

  /* Touch optimization */
  input, button, select, textarea {
    min-height: 44px;
  }

  @media (hover: hover) {
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(63, 103, 230, 0.2);
    }

    .export-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(11, 110, 79, 0.2);
    }

    .quick-grid button:hover {
      background: var(--accent);
      color: white;
      transform: translateY(-2px);
    }
  }
</style>
</head>
<body>
<div class="wrap">
  <h1>üí∞ Add Expense</h1>
  <a class="link" href="dashboard.html">‚Üê Back to Dashboard</a>

  <!-- Input card -->
  <div class="card" style="margin-top: 12px;">
    <label>Amount (‚Çπ)</label>
    <input id="amt" type="number" placeholder="0" inputmode="decimal" />

    <label style="margin-top: 10px;">Category</label>
    <input id="cat" list="catList" placeholder="Type or select category" />
    <datalist id="catList"></datalist>

    <label style="margin-top: 10px;">Note (optional)</label>
    <textarea id="note" placeholder="Add a note..."></textarea>

    <div class="row" style="margin-top: 16px;">
      <button class="btn" id="saveBtn">‚úì Save Expense</button>
      <button id="refreshCats" class="btn secondary">‚Üª Refresh</button>
    </div>
  </div>

  <div class="grid">
    <div>
      <!-- Highest Expenses KPI -->
      <div class="card">
        <h3>Highest Expenses</h3>
        <div class="kpi-row" id="kpis">
          <div class="kpi">
            <div class="small">This month</div>
            <div id="hiThis">‚Äî</div>
            <div class="muted" id="hiThisMeta"></div>
          </div>
          <div class="kpi">
            <div class="small">Last 3 months</div>
            <div id="hi3">‚Äî</div>
            <div class="muted" id="hi3Meta"></div>
          </div>
          <div class="kpi">
            <div class="small">Last 6 months</div>
            <div id="hi6">‚Äî</div>
            <div class="muted" id="hi6Meta"></div>
          </div>
          <div class="kpi">
            <div class="small">Last 12 months</div>
            <div id="hi12">‚Äî</div>
            <div class="muted" id="hi12Meta"></div>
          </div>
        </div>
      </div>

      <!-- Recent Expenses -->
      <div class="card">
        <div class="card-header">
          <div>
            <h3>Recent Expenses</h3>
            <div class="small">Latest items appear at top</div>
          </div>
          <button id="exportBtn" class="export-btn">üì• Export CSV</button>
        </div>
        <table id="expTable">
          <thead>
            <tr>
              <th>Sl.</th>
              <th>Category</th>
              <th>Price (‚Çπ)</th>
              <th>Date</th>
              <th>Time</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <!-- Category Analysis -->
      <div class="card">
        <h3>Category Analysis</h3>
        
        <div class="delete-row">
          <select id="deleteCategory" style="margin-top: 0;">
            <option value="">-- choose to delete --</option>
          </select>
          <button id="deleteCatBtn" class="btn danger" style="min-width: 120px;">üóëÔ∏è Delete</button>
        </div>

        <div class="controls-col">
          <div>
            <label style="margin: 0 0 8px; display: block;">Analyze category:</label>
            <select id="analysisCategory" style="margin-top: 0;"></select>
          </div>

          <div>
            <label style="margin: 0 0 10px; display: block; font-weight: 600;">Range:</label>
            <div class="row">
              <label style="display: flex; align-items: center; margin: 0; font-weight: normal; flex: 1;">
                <input type="radio" name="range" value="3" checked style="margin-right: 6px;" />
                3 months
              </label>
              <label style="display: flex; align-items: center; margin: 0; font-weight: normal; flex: 1;">
                <input type="radio" name="range" value="6" style="margin-right: 6px;" />
                6 months
              </label>
              <label style="display: flex; align-items: center; margin: 0; font-weight: normal; flex: 1;">
                <input type="radio" name="range" value="12" style="margin-right: 6px;" />
                12 months
              </label>
            </div>
          </div>

          <div>
            <label style="margin: 0 0 8px; display: block;">Data type:</label>
            <select id="lineData" style="margin-top: 0;">
              <option value="share">Share %</option>
              <option value="amount">Monthly amount</option>
            </select>
          </div>

          <div>
            <label style="display: flex; align-items: center; margin: 0; font-weight: normal; cursor: pointer;">
              <input id="showPie" type="checkbox" style="margin-right: 8px; width: auto; cursor: pointer;" />
              Show Pie Chart
            </label>
            <button id="showAnalysis" class="btn" style="margin-top: 12px; width: 100%;">üìä Show Analysis</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Right Sidebar -->
    <div>
      <!-- Quick Category Links -->
      <div class="card">
        <h3>Category breakdown</h3>
        <div class="small">Click to analyze quickly</div>
        <div id="quickCats" class="quick-grid"></div>
      </div>

      <!-- Personalized Suggestions -->
      <div id="suggestionsArea" class="card suggest-box">
        <div class="suggest-title">
          <div class="dot"></div>
          <div>Personalized Tips</div>
        </div>
        <div id="suggestText" class="suggest-content">
          Choose a category and range then press <strong>Show Analysis</strong>. Tips will appear here.
        </div>
        <div class="suggest-tips" id="suggestTips">
          üí° Tip: If a category is >30% of your total spending, consider setting a monthly cap.
        </div>
      </div>
    </div>
  </div>

  <!-- Charts Section with Swipe Navigation -->
  <div class="card chart-card">
    <div class="chart-header">
      <h3>üìä Charts</h3>
      <div class="swipe-indicator">üëÜ Swipe or tap to navigate</div>
    </div>

    <div class="chart-carousel" id="chartCarousel" role="region" aria-label="Charts carousel">
      <div class="chart-slides" id="chartSlides">
        <!-- Slide 1: Line Chart -->
        <div class="chart-slide">
          <div class="chart-holder">
            <div class="chart-title" id="chartTitle">Category share (last 3 mo)</div>
            <canvas id="lineChart" aria-label="Line chart"></canvas>
          </div>
        </div>

        <!-- Slide 2: Bar/Pie Chart -->
        <div class="chart-slide">
          <div class="chart-holder">
            <div class="chart-title" id="barTitle">Totals by category (last 3 mo)</div>
            <canvas id="barChart" aria-label="Bar chart"></canvas>
            <canvas id="pieChart" aria-label="Pie chart" style="display: none;"></canvas>
          </div>
        </div>
      </div>
    </div>

    <!-- Navigation Controls -->
    <div class="chart-nav">
      <button id="prevChart" class="nav-btn">‚Üê Prev</button>
      <span class="chart-counter"><span id="currentSlide">1</span> / 2</span>
      <button id="nextChart" class="nav-btn">Next ‚Üí</button>
    </div>
  </div>
</div>

<script>
/* ============= IMPROVED CHART CAROUSEL WITH SWIPE ============= */
let currentSlide = 0;
const slides = 2;
const carousel = document.getElementById('chartCarousel');
const chartSlides = document.getElementById('chartSlides');
const prevBtn = document.getElementById('prevChart');
const nextBtn = document.getElementById('nextChart');
const currentSlideSpan = document.getElementById('currentSlide');

let touchStartX = 0;
let touchStartY = 0;
let touchEndX = 0;
let isAnimating = false;
let isDragging = false;

function updateSlide() {
  if (isAnimating) return;

  const offset = -currentSlide * 100;
  chartSlides.style.transform = `translateX(${offset}%)`;
  currentSlideSpan.textContent = currentSlide + 1;

  prevBtn.disabled = currentSlide === 0;
  nextBtn.disabled = currentSlide === slides - 1;
}

function nextSlide() {
  if (currentSlide < slides - 1 && !isAnimating) {
    isAnimating = true;
    currentSlide++;
    updateSlide();
    setTimeout(() => { isAnimating = false; }, 400);
  }
}

function prevSlide() {
  if (currentSlide > 0 && !isAnimating) {
    isAnimating = true;
    currentSlide--;
    updateSlide();
    setTimeout(() => { isAnimating = false; }, 400);
  }
}

// Button click handlers
prevBtn.addEventListener('click', prevSlide);
nextBtn.addEventListener('click', nextSlide);

// Improved touch handlers
carousel.addEventListener('touchstart', (e) => {
  if (isAnimating) return;
  touchStartX = e.touches[0].clientX;
  touchStartY = e.touches[0].clientY;
  isDragging = true;
  chartSlides.classList.add('no-transition');
}, { passive: true });

carousel.addEventListener('touchmove', (e) => {
  if (!isDragging || isAnimating) return;
  touchEndX = e.touches[0].clientX;
  
  const diff = touchStartX - touchEndX;
  const dragPercent = (diff / carousel.offsetWidth) * 100;
  const baseOffset = -currentSlide * 100;
  
  chartSlides.style.transform = `translateX(${baseOffset - dragPercent}%)`;
}, { passive: true });

carousel.addEventListener('touchend', (e) => {
  if (!isDragging) return;
  isDragging = false;
  
  chartSlides.classList.remove('no-transition');
  
  const diff = touchStartX - touchEndX;
  const threshold = carousel.offsetWidth * 0.2; // 20% of carousel width
  
  if (Math.abs(diff) > threshold && !isAnimating) {
    if (diff > 0) {
      nextSlide(); // swiped left
    } else {
      prevSlide(); // swiped right
    }
  } else {
    updateSlide(); // snap back
  }
}, { passive: true });

// Mouse drag support
let mouseDownX = 0;
carousel.addEventListener('mousedown', (e) => {
  mouseDownX = e.clientX;
  isDragging = true;
  chartSlides.classList.add('no-transition');
});

document.addEventListener('mousemove', (e) => {
  if (!isDragging || isAnimating) return;
  const diff = mouseDownX - e.clientX;
  const dragPercent = (diff / carousel.offsetWidth) * 100;
  const baseOffset = -currentSlide * 100;
  chartSlides.style.transform = `translateX(${baseOffset - dragPercent}%)`;
});

document.addEventListener('mouseup', (e) => {
  if (!isDragging) return;
  isDragging = false;
  chartSlides.classList.remove('no-transition');
  
  const diff = mouseDownX - e.clientX;
  const threshold = carousel.offsetWidth * 0.2;
  
  if (Math.abs(diff) > threshold && !isAnimating) {
    if (diff > 0) {
      nextSlide();
    } else {
      prevSlide();
    }
  } else {
    updateSlide();
  }
});

// Keyboard navigation
document.addEventListener('keydown', (e) => {
  if (e.key === 'ArrowLeft') nextSlide();
  else if (e.key === 'ArrowRight') prevSlide();
});

// Initialize
updateSlide();

/* ============= EXPENSE TRACKER LOGIC ============= */
const EXP_KEY = 'expenses';

function loadExpenses() {
  try {
    const r = localStorage.getItem(EXP_KEY);
    return r ? JSON.parse(r) : [];
  } catch (e) {
    console.error('Error loading expenses:', e);
    return [];
  }
}

function saveExpenses(arr) {
  try {
    localStorage.setItem(EXP_KEY, JSON.stringify(arr));
  } catch (e) {
    console.error('Unable to save expenses', e);
    alert('Unable to save - localStorage error');
  }
}

function formatDateISO(dISO) {
  const dt = new Date(dISO);
  if (isNaN(dt)) return { date: 'Invalid Date', time: 'Invalid Date' };
  return {
    date: dt.toLocaleDateString('en-GB', { day: '2-digit', month: '2-digit', year: 'numeric' }),
    time: dt.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' })
  };
}

function monthDiff(d1, d2) {
  const y1 = d1.getFullYear(), m1 = d1.getMonth();
  const y2 = d2.getFullYear(), m2 = d2.getMonth();
  return (y2 - y1) * 12 + (m2 - m1);
}

const defaultCats = ["Food", "Rent", "Travel", "Vehicle loan", "Home loan", "Education", "Entertainment", "Miscellaneous"];

function getCategories() {
  const arr = loadExpenses();
  const set = new Set(defaultCats);
  arr.forEach(e => set.add(e.category));
  return Array.from(set).sort();
}

function populateCategorySelects() {
  const sel = document.getElementById('analysisCategory');
  const del = document.getElementById('deleteCategory');
  const quick = document.getElementById('quickCats');
  const dataList = document.getElementById('catList');

  sel.innerHTML = '';
  del.innerHTML = '<option value="">-- choose to delete --</option>';
  quick.innerHTML = '';
  dataList.innerHTML = '';

  const allOpt = document.createElement('option');
  allOpt.value = '__ALL__';
  allOpt.innerText = 'All categories';
  sel.appendChild(allOpt);

  getCategories().forEach(c => {
    const o = document.createElement('option');
    o.value = c;
    o.innerText = c;
    sel.appendChild(o);

    const od = document.createElement('option');
    od.value = c;
    od.innerText = c;
    del.appendChild(od);

    const dopt = document.createElement('option');
    dopt.value = c;
    dataList.appendChild(dopt);

    const btn = document.createElement('button');
    btn.type = 'button';
    btn.innerText = c;
    btn.addEventListener('click', (e) => {
      e.preventDefault();
      document.getElementById('analysisCategory').value = c;
      document.querySelector('input[name=range][value=3]').checked = true;
      runAnalysis();
    });
    quick.appendChild(btn);
  });

  const catInput = document.getElementById('cat');
  if (!catInput.value) catInput.value = getCategories()[0] || '';
}

function renderRecent() {
  const tbody = document.querySelector('#expTable tbody');
  tbody.innerHTML = '';
  const ex = loadExpenses();
  ex.slice(0, 200).forEach((r, i) => {
    const tr = document.createElement('tr');
    const dt = formatDateISO(r.dateISO);
    tr.innerHTML = `
      <td>${i + 1}</td>
      <td>${r.category}</td>
      <td>‚Çπ${r.amount.toLocaleString()}</td>
      <td>${dt.date}</td>
      <td>${dt.time}</td>
    `;
    tbody.appendChild(tr);
  });
}

function highestInRange(months) {
  const ex = loadExpenses();
  const now = new Date();
  let best = null;
  ex.forEach(e => {
    const d = new Date(e.dateISO);
    const diff = monthDiff(d, now);
    if (diff <= months - 1 && diff >= 0) {
      if (!best || e.amount > best.amount) best = e;
    }
  });
  return best;
}

function computeKpis() {
  const hiThis = highestInRange(1);
  const hi3 = highestInRange(3);
  const hi6 = highestInRange(6);
  const hi12 = highestInRange(12);

  function fill(el, metaEl, obj) {
    if (!obj) {
      el.innerText = '‚Äî';
      metaEl.innerText = '';
      return;
    }
    el.innerText = '‚Çπ' + obj.amount.toLocaleString();
    const dt = formatDateISO(obj.dateISO);
    metaEl.innerText = `${obj.category} ‚Ä¢ ${dt.date}`;
  }

  fill(document.getElementById('hiThis'), document.getElementById('hiThisMeta'), hiThis);
  fill(document.getElementById('hi3'), document.getElementById('hi3Meta'), hi3);
  fill(document.getElementById('hi6'), document.getElementById('hi6Meta'), hi6);
  fill(document.getElementById('hi12'), document.getElementById('hi12Meta'), hi12);
}

document.getElementById('deleteCatBtn').addEventListener('click', () => {
  const c = document.getElementById('deleteCategory').value;
  if (!c) {
    alert('Please choose a category to delete');
    return;
  }
  if (!confirm(`Delete ALL expenses in "${c}"? This cannot be undone.`)) return;

  const ex = loadExpenses().filter(x => x.category !== c);
  saveExpenses(ex);
  populateCategorySelects();
  renderRecent();
  computeKpis();
  runAnalysis();
  alert(`Category "${c}" deleted successfully`);
});

let lineChart = null, barChart = null, pieChart = null;

function monthlyBuckets(rangeMonths) {
  const now = new Date();
  const res = [];
  for (let i = rangeMonths - 1; i >= 0; i--) {
    const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
    const label = d.toLocaleString('en-GB', { month: 'short', year: '2-digit' });
    res.push({ label, date: d, total: 0, byCategory: {} });
  }

  const ex = loadExpenses();
  ex.forEach(e => {
    const ed = new Date(e.dateISO);
    const diff = monthDiff(ed, now);
    if (diff <= (rangeMonths - 1) && diff >= 0) {
      const index = rangeMonths - 1 - diff;
      res[index].total += e.amount;
      res[index].byCategory[e.category] = (res[index].byCategory[e.category] || 0) + e.amount;
    }
  });

  return res;
}

const suggestionsPool = {
  'Food': [
    'Limit outside-food to 2 times per week, meal-prep on weekends.',
    'Track "food outside" separately to identify cost leaks.'
  ],
  'Rent': [
    'Ensure 3-6 months emergency buffer for rent/EMI.',
    'If rent >40% of income, consider relocating or restructuring.'
  ],
  'Travel': [
    'Use public transport monthly passes or carpool to save.',
    'Track fuel vs. other travel costs separately for better insights.'
  ],
  'Vehicle loan': [
    'Look for loan refinancing at lower rates.',
    'Small prepayments can significantly reduce total interest paid.'
  ],
  'Home loan': [
    'Check refinancing options and claim tax benefits.',
    'Keep loan EMI below 40% of net income if possible.'
  ],
  'Education': [
    'Explore scholarships, installment plans, and free resources.',
    'Spread education costs across multiple months.'
  ],
  'Entertainment': [
    'Audit all subscriptions and cancel unused ones.',
    'Set a monthly entertainment budget and stick to it.'
  ],
  'Miscellaneous': [
    'Group small purchases weekly and review monthly.',
    'Keep a separate budget for petty cash expenses.'
  ]
};

function computeSuggestionsAll(ag) {
  const entries = Object.entries(ag).sort((a, b) => b[1] - a[1]);
  const total = entries.reduce((s, e) => s + e[1], 0) || 1;
  const topItems = entries.slice(0, 3).map(([k, v]) => {
    const pct = Math.round((v / total) * 10000) / 100;
    return `<strong>${k}</strong>: ${pct}%`;
  }).join(' ‚Ä¢ ');

  const area = document.getElementById('suggestText');
  const tips = document.getElementById('suggestTips');
  area.innerHTML = `<div style="font-weight: 600; margin-bottom: 6px;">Top spending categories</div><div>${topItems || 'No data'}</div>`;
  tips.innerHTML = `üí° Identify your top category and set a monthly spending cap for it. Small reductions compound over time.`;
}

function computeSuggestions(cat, range, metric, buckets, catSeries, totalSeries) {
  const totalSum = totalSeries.reduce((a, b) => a + b, 0);
  const catSum = catSeries.reduce((a, b) => a + b, 0);
  const sharePct = totalSum ? Math.round((catSum / totalSum) * 10000) / 100 : 0;
  const pool = suggestionsPool[cat] || ['Monitor this category regularly; small costs add up.'];

  let suggestion = `${cat} accounts for <strong>${sharePct}%</strong> of your spending.`;
  if (sharePct >= 40) suggestion = `‚ö†Ô∏è High spending on ${cat} ‚Äî ${pool[0]}`;
  else if (sharePct >= 25) suggestion = `${cat} is <strong>${sharePct}%</strong> of spending. ${pool[0]}`;
  else if (sharePct >= 10) suggestion = `${cat} is moderate at <strong>${sharePct}%</strong>. ${pool[1] || pool[0]}`;
  else suggestion = `Good ‚Äî ${cat} is only <strong>${sharePct}%</strong> of spending. Keep tracking.`;

  const avgMonthly = range ? Math.round(catSum / range) : 0;

  const sugArea = document.getElementById('suggestText');
  const tips = document.getElementById('suggestTips');

  if (sharePct >= 35) {
    document.getElementById('suggestionsArea').className = 'card suggest-box danger-suggest';
  } else {
    document.getElementById('suggestionsArea').className = 'card suggest-box';
  }

  sugArea.innerHTML = `<div style="font-weight: 600; margin-bottom: 6px;">${suggestion}</div><div style="margin-top: 6px;">${pool[0]}</div>`;
  tips.innerHTML = `‚ö° Next step: 1) Set a monthly cap for ${cat}. 2) Review top sub-categories. 3) Look for alternatives or discounts.`;
}

function runAnalysis() {
  const selVal = document.getElementById('analysisCategory').value;
  const isAll = selVal === '__ALL__';
  const range = Number(document.querySelector('input[name=range]:checked').value);
  const lineMetric = document.getElementById('lineData').value;
  const showPie = document.getElementById('showPie').checked;
  const buckets = monthlyBuckets(range);
  const labels = buckets.map(b => b.label);
  const totalSeries = buckets.map(b => b.total || 0);

  const aggregatePerCategory = {};
  buckets.forEach(b => {
    for (const k in b.byCategory) {
      aggregatePerCategory[k] = (aggregatePerCategory[k] || 0) + b.byCategory[k];
    }
  });

  if (lineChart) { lineChart.destroy(); lineChart = null; }
  if (barChart) { barChart.destroy(); barChart = null; }
  if (pieChart) { pieChart.destroy(); pieChart = null; }

  const colors = ['#ef4444', '#f97316', '#facc15', '#4ade80', '#60a5fa', '#a78bfa', '#f472b6', '#9ca3af', '#7c3aed', '#0ea5a0'];

  if (isAll) {
    const cats = Object.keys(aggregatePerCategory).length ? Object.keys(aggregatePerCategory) : getCategories();
    const datasets = cats.map((cat, idx) => {
      const series = buckets.map(b => b.byCategory[cat] || 0);
      const data = lineMetric === 'share' 
        ? series.map((v, i) => totalSeries[i] ? Math.round((v / totalSeries[i]) * 10000) / 100 : 0)
        : series;
      return {
        label: cat,
        data,
        borderColor: colors[idx % colors.length],
        backgroundColor: 'rgba(0,0,0,0)',
        tension: 0.35,
        pointRadius: 3,
        pointBackgroundColor: colors[idx % colors.length]
      };
    });

    const ctxL = document.getElementById('lineChart').getContext('2d');
    lineChart = new Chart(ctxL, {
      type: 'line',
      data: { labels, datasets },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        interaction: { intersect: false, mode: 'index' },
        scales: {
          y: {
            beginAtZero: true,
            ticks: { callback: v => lineMetric === 'share' ? v + '%' : '‚Çπ' + v.toLocaleString() }
          }
        },
        plugins: {
          legend: { position: 'bottom', labels: { boxWidth: 12, padding: 12 } }
        }
      }
    });

    const pLabels = Object.keys(aggregatePerCategory);
    const pData = pLabels.map(k => aggregatePerCategory[k]);
    document.getElementById('barChart').style.display = showPie ? 'none' : '';
    document.getElementById('pieChart').style.display = showPie ? '' : 'none';

    if (showPie) {
      const ctxP = document.getElementById('pieChart').getContext('2d');
      pieChart = new Chart(ctxP, {
        type: 'pie',
        data: {
          labels: pLabels,
          datasets: [{
            data: pData,
            backgroundColor: colors.slice(0, pLabels.length)
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { position: 'bottom', labels: { padding: 12 } }
          }
        }
      });
    } else {
      const ctxB = document.getElementById('barChart').getContext('2d');
      barChart = new Chart(ctxB, {
        type: 'bar',
        data: {
          labels: pLabels,
          datasets: [{
            label: 'Total',
            data: pData,
            backgroundColor: colors.slice(0, pLabels.length)
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true,
              ticks: { callback: v => '‚Çπ' + v.toLocaleString() }
            }
          },
          plugins: { legend: { display: false } }
        }
      });
    }

    document.getElementById('chartTitle').innerText = `All categories ‚Äî ${lineMetric === 'share' ? 'Share %' : 'Amount'} (${range}m)`;
    document.getElementById('barTitle').innerText = `Totals by category (${range}m)`;
    computeSuggestionsAll(aggregatePerCategory);
    return;
  }

  const cat = selVal;
  const catSeries = buckets.map(b => b.byCategory[cat] || 0);
  const displaySeries = lineMetric === 'share'
    ? catSeries.map((v, i) => totalSeries[i] ? Math.round((v / totalSeries[i]) * 10000) / 100 : 0)
    : catSeries;

  const ctxL = document.getElementById('lineChart').getContext('2d');
  lineChart = new Chart(ctxL, {
    type: 'line',
    data: {
      labels,
      datasets: [{
        label: lineMetric === 'share' ? '% share' : 'Amount',
        data: displaySeries,
        fill: true,
        tension: 0.35,
        pointRadius: 4,
        pointBackgroundColor: '#2563eb',
        borderColor: '#2563eb',
        backgroundColor: 'rgba(37, 99, 235, 0.08)'
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        y: {
          beginAtZero: true,
          ticks: { callback: v => lineMetric === 'share' ? v + '%' : '‚Çπ' + v.toLocaleString() }
        }
      },
      plugins: { legend: { display: true, position: 'bottom' } }
    }
  });

  document.getElementById('barChart').style.display = showPie ? 'none' : '';
  document.getElementById('pieChart').style.display = showPie ? '' : 'none';

  if (!showPie) {
    const ctxB = document.getElementById('barChart').getContext('2d');
    barChart = new Chart(ctxB, {
      type: 'bar',
      data: {
        labels,
        datasets: [
          { label: cat, data: catSeries, backgroundColor: 'rgba(79, 70, 229, 0.9)' },
          { label: 'Total', data: totalSeries, backgroundColor: 'rgba(203, 213, 225, 0.5)' }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y: {
            beginAtZero: true,
            ticks: { callback: v => '‚Çπ' + v.toLocaleString() }
          }
        },
        plugins: { legend: { position: 'bottom' } }
      }
    });
  } else {
    const ag = {};
    buckets.forEach(b => {
      for (const k in b.byCategory) {
        ag[k] = (ag[k] || 0) + b.byCategory[k];
      }
    });
    const pLabels = Object.keys(ag);
    const pData = pLabels.map(k => ag[k]);

    const ctxP = document.getElementById('pieChart').getContext('2d');
    pieChart = new Chart(ctxP, {
      type: 'pie',
      data: {
        labels: pLabels,
        datasets: [{
          data: pData,
          backgroundColor: colors.slice(0, pLabels.length)
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { position: 'bottom' } }
      }
    });
  }

  computeSuggestions(cat, range, lineMetric, buckets, catSeries, totalSeries);
  document.getElementById('chartTitle').innerText = `${cat} ‚Äî ${lineMetric === 'share' ? 'Share %' : 'Amount'} (${range}m)`;
  document.getElementById('barTitle').innerText = `Breakdown (${range}m)`;
}

// Save Expense Handler
document.getElementById('saveBtn').addEventListener('click', function() {
  try {
    const amtEl = document.getElementById('amt');
    const catEl = document.getElementById('cat');
    const noteEl = document.getElementById('note');

    if (!amtEl || !catEl || !noteEl) {
      alert('Internal error: form fields missing');
      return;
    }

    const rawAmt = amtEl.value.trim();
    const amount = rawAmt === '' ? NaN : parseFloat(rawAmt);
    const category = (catEl.value || '').trim();
    const note = (noteEl.value || '').trim();

    if (Number.isNaN(amount) || amount <= 0) {
      alert('Enter a valid amount greater than 0');
      amtEl.focus();
      return;
    }

    if (!category) {
      alert('Please select a category');
      catEl.focus();
      return;
    }

    const expense = {
      amount: Math.round(amount),
      category,
      note,
      dateISO: new Date().toISOString()
    };

    let arr = [];
    try {
      const raw = localStorage.getItem(EXP_KEY);
      arr = raw ? JSON.parse(raw) : [];
      if (!Array.isArray(arr)) arr = [];
    } catch (e) {
      arr = [];
      console.warn('Error parsing expenses:', e);
    }

    arr.unshift(expense);
    saveExpenses(arr);

    amtEl.value = '';
    noteEl.value = '';

    populateCategorySelects();
    renderRecent();
    computeKpis();
    runAnalysis();

    alert('‚úì Expense saved successfully');
  } catch (err) {
    console.error('Save failed:', err);
    alert('Save failed ‚Äî check console');
  }
});

document.getElementById('refreshCats').addEventListener('click', () => {
  populateCategorySelects();
  alert('Categories refreshed');
});

document.getElementById('showAnalysis').addEventListener('click', runAnalysis);
document.getElementById('showPie').addEventListener('change', runAnalysis);

// Range change handlers
document.querySelectorAll('input[name=range]').forEach(el => {
  el.addEventListener('change', runAnalysis);
});

// Data type change handler
document.getElementById('lineData').addEventListener('change', runAnalysis);

// CSV Export
function csvEscape(v) {
  if (v == null) return '';
  const s = String(v);
  if (s.includes(',') || s.includes('"') || s.includes('\n')) {
    return `"${s.replace(/"/g, '""')}"`;
  }
  return s;
}

function exportCSV() {
  const rows = loadExpenses();
  if (!rows || rows.length === 0) {
    alert('No expenses to export');
    return;
  }

  const header = ['Sl', 'Category', 'Amount', 'Date', 'Time', 'Note'];
  const lines = [header.join(',')];

  rows.forEach((r, i) => {
    const dt = formatDateISO(r.dateISO);
    const line = [i + 1, r.category, r.amount, dt.date, dt.time, r.note || ''];
    lines.push(line.map(csvEscape).join(','));
  });

  const csv = lines.join('\n');
  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const now = new Date();
  const fname = `expenses-${now.getFullYear()}${String(now.getMonth() + 1).padStart(2, '0')}${String(now.getDate()).padStart(2, '0')}.csv`;

  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = fname;
  document.body.appendChild(link);
  link.click();
  link.remove();

  alert('‚úì CSV exported successfully');
}

document.getElementById('exportBtn').addEventListener('click', exportCSV);

// Initialize
function init() {
  populateCategorySelects();
  renderRecent();
  computeKpis();

  const ex = loadExpenses();
  if (ex.length === 0) {
    const now = new Date();
    const sample = [
      {
        amount: 500,
        category: 'Miscellaneous',
        note: 'Sample entry',
        dateISO: new Date(now.getFullYear(), now.getMonth(), 21, 16, 47).toISOString()
      },
      {
        amount: 200,
        category: 'Food',
        note: 'Sample entry',
        dateISO: new Date(now.getFullYear(), now.getMonth(), 21, 16, 38).toISOString()
      }
    ];
    saveExpenses(sample);
    populateCategorySelects();
    renderRecent();
    computeKpis();
  }

  document.getElementById('analysisCategory').value = '__ALL__';
  runAnalysis();
}

init();
</script>
</body>
</html>